---
title: "proxmox quick config"
date: 2023-03-24
tags:
- proxmox
categories:
- misc
draft: true
---


```bash
#/etc/network/interfaces
source /etc/network/interfaces.d/*

auto lo
iface lo inet loopback

iface lo inet6 loopback

auto eno1
iface eno1 inet static
#	address 1.2.3.4/26
#	gateway 1.2.3.4
	up route add -net 11.2.3.4 netmask 255.255.255.192 gw 1.2.3.4 dev eno1
# route 1.2.3.4/24 via 4.5.6.7

iface eth0 inet manual

auto vmbr0
iface vmbr0 inet static
      address  1.2.3.4
      netmask  255.255.255.192
      gateway  4.5.6.7
      bridge_ports eno1
      bridge_stp off
      bridge_fd 0

# Internal IP address range.
auto vmbr1
iface vmbr1 inet static
      bridge_ports none
      bridge_fd 0
      bridge_maxwait 0
      address 192.168.0.1
      netmask 255.255.255.0
      bridge_stp off
      post-up iptables -t nat -A POSTROUTING -s '192.168.0.0/24'  -o vmbr0 -j MASQUERADE

```

```bash
#dnsmasq.conf
server=213.186.33.99
address=/host/192.168.0.30
address=/host2/192.168.0.31
host-record=static,192.160.0.32
host-record=static2,192.160.0.34
interface=vmbr1
domain=my.domain
dhcp-range=192.168.0.100,192.168.0.150,12h
dhcp-option=vmbr1,3,192.168.0.1
dhcp-boot=pxelinux.0
enable-tftp
tftp-root=/var/lib/vz/tftp

```


```bash
#iptables

# Generated by iptables-save v1.8.9 on Fri Nov 24 18:34:52 2023
*nat
:PREROUTING ACCEPT [1783:98205]
:INPUT ACCEPT [383:22784]
:OUTPUT ACCEPT [107:7429]
:POSTROUTING ACCEPT [107:7429]
-A POSTROUTING -s 192.168.0.0/24 -o vmbr0 -j MASQUERADE
-A POSTROUTING -s 192.168.0.0/24 -o vmbr0 -j MASQUERADE
COMMIT
# Completed on Fri Nov 24 18:34:52 2023
# Generated by iptables-save v1.8.9 on Fri Nov 24 18:34:52 2023
*filter
:INPUT DROP [23:1380]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [168:80744]
-A INPUT -p tcp -m tcp --sport 53 -j ACCEPT
-A INPUT -p udp -m udp --dport 53 -j ACCEPT
-A INPUT -p udp -m udp --sport 53 -j ACCEPT
-A INPUT -p tcp -m tcp --sport 53 -j ACCEPT
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A OUTPUT -o lo -j ACCEPT
COMMIT
# Completed on Fri Nov 24 18:34:52 2023
# Generated by iptables-save v1.8.9 on Fri Nov 24 18:34:52 2023
*raw
:PREROUTING ACCEPT [6531:1351014]
:OUTPUT ACCEPT [4421:4123306]
COMMIT
# Completed on Fri Nov 24 18:34:52 2023

```

```bash
#knockd
[options]
	UseSyslog

[openSSH]
	sequence    = 7000,8000,9000
	seq_timeout = 5
	start_command     = /sbin/iptables -A INPUT -p tcp --dport 2222 -j ACCEPT
    cmd_timeout = 300
    stop_command     = /sbin/iptables -D INPUT -p tcp --dport 2222 -j ACCEPT
	tcpflags    = syn

[closeSSH]
	sequence    = 9000,8000,7000
	seq_timeout = 5
	command     = /sbin/iptables -D INPUT -p tcp --dport 2222 -j ACCEPT
	tcpflags    = syn

[openingress]
	sequence    = 1234,4567
	seq_timeout = 5
	start_command     =  /sbin/open
    cmd_timeout = 300
	stop_command     =  /sbin/close
	tcpflags    = syn

[proxmox]
	sequence    = 8000,9000,10000
	seq_timeout = 5
	start_command     = /sbin/iptables -A INPUT -p tcp --dport 8006 -j ACCEPT
    cmd_timeout = 300
	stop_command     = /sbin/iptables -D INPUT -p tcp --dport 8006 -j ACCEPT
	tcpflags    = syn

# /sbin/open
# /sbin/iptables -t nat -A PREROUTING -i vmbr0 -p tcp --dport 443 -j DNAT --to 192.168.0.51:443
# /sbin/iptables -t nat -A PREROUTING -i vmbr0 -p tcp --dport 6443 -j DNAT --to 192.168.0.50:6443
# /sbin/close
# /sbin/iptables -t nat -D PREROUTING -i vmbr0 -p tcp --dport 443 -j DNAT --to 192.168.0.51:443
# /sbin/iptables -t nat -D PREROUTING -i vmbr0 -p tcp --dport 6443 -j DNAT --to 192.168.0.50:6443

```